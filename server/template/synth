<html>
   <head>
       <title>Sound Pendulum</title>
       <script type="text/javascript" src="/static/js/jquery-1.10.2.min.js"></script>
       <script type="text/javascript" src="/static/js/socket.io.min.js"></script>
       <script type="text/javascript" src="/static/js/buffer-loader.js"></script>
       <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.css">
   </head>
   <body>

       <a class="btn btn-large" onclick="play()">Play</a>
       <a class="btn btn-large" onclick="pause()">Pause</a>


   </body>
<script>

// Modulation notes: 
// use gain node to scale to 200. 
// use another osc to be the modulating oscilator 

var max_volume = 1.0;
var osc_volume = .15;

var ctx = new AudioContext();

var osc = ctx.createOscillator()
osc.type = "sine";

var osc2 = ctx.createOscillator()
osc2.frequency.value = 1000; 
osc2.type = "sawtooth";

var master_gain = ctx.createGain();
master_gain.gain.value = max_volume;

var osc_gain = ctx.createGain();
osc_gain.gain.value = osc_volume;

osc.connect(osc_gain);
osc2.connect(osc_gain);

var sound0, sound1;

osc_gain.connect(master_gain);
master_gain.connect(ctx.destination);

bufferLoader = new BufferLoader(
   ctx,
   [ 'static/wav/drum.wav', 'static/wav/boop.wav', ],
   finishedLoading
);
bufferLoader.load();

function finishedLoading(bufferList)
{
    sound0 = bufferList[0];
    sound1 = bufferList[1];

    osc.start(0);
    osc2.start(0);
}

function playSound(ctx, buffer) 
{
  var source = ctx.createBufferSource(); 
  source.buffer = buffer;               
  source.connect(master_gain);
  source.start(0);                    
}

function play()
{
    master_gain.gain.value = max_volume;
}
function pause()
{
    master_gain.gain.value = 0;
}

var last_z = 0, sign = 0;

function handler(t, x, y, z)
{
    f = 350+ (z * 5);
    osc.frequency.value = f;

    f = 350 + (x * 10);
    osc2.frequency.value = f;

    if (last_z == 0)
        last_z = z;

    if (z > last_z && sign <= 0)
        sign = 1;
    else
    if (z < last_z && sign >= 0)
    {
        sign = -1;
        playSound(ctx, sound0);
    }

    last_z = z;
}

$(document).ready(function() 
{
    namespace = '/pendulum'; 
    var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
    socket.on('data', function(msg) {
        d = msg.data.split(",");
        handler(parseInt(d[0]), parseInt(d[1]), parseInt(d[2]), parseInt(d[3]));
    });
});

</script>
</body>
</html>
